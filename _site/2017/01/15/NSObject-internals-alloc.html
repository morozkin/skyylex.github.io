<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Nsobject internals   alloc</title>
  <meta name="description" content="NSObject Internals. Episode 1 - alloc">

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Lato">
  <link rel="canonical" href="http://localhost:4000/2017/01/15/NSObject-internals-alloc.html">
  <link rel="alternate" type="application/rss+xml" title="Software Engineering blog" href="/feed.xml">
  
  
</head>

  <body>

    <style>
.common_footer {
}

.common_header {
  background-color : rgb(238,238,238);
}

.context_text { 
  text-align: left; 
  line-height: 140%;
}

.nav_anchor {
  text-decoration: underline; 
  white-space: pre; 
  vertical-align: text-bottom;
}

</style>
<header class="common_header site-header" role="banner">
  <div class="wrapper">
    <span style="float: left;">
      <div style="font-weight: bold;">Software Engineering blog</div>
      <div>&nbsp</div>
      <div>author: Yury Lapitsky</div>
      <div>e-mail: yury.lapitsky@gmail.com</div>
    </span>

    <span style="float: right;">
      <div>
        <span>
          [<a class="nav_anchor" href="/">home</a>]
        </span>
        <span>
          [<a class="nav_anchor" href="/posts">posts</a>]
        </span>
        <span>
          [<a class="nav_anchor" href="/projects">projects</a>]
        </span>
        <span>
          [<a class="nav_anchor" href="/about">about</a>]
        </span>
      </div>
      <br>
    </span>

  </div>

</header>

    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <p><strong>NSObject Internals. Episode 1 - alloc</strong></p>

<p><strong>Introduction</strong></p>

<p>Today I want to start a series of posts related to investigation of the available <code class="highlighter-rouge">NSObject</code>’s source code. <code class="highlighter-rouge">NSObject</code> is one of the root classes in Objective-C and most of the core concepts of Objective-C are located there. The format of investigation will evolve, at this moment I think that the most useful description should be a combination of the info from source code and official documentation.</p>

<p><strong>Official alloc</strong></p>

<p>Let’s start from the available API for the <code class="highlighter-rouge">alloc</code>:</p>

<p><code class="highlighter-rouge">+ (id)alloc;</code></p>

<p><code class="highlighter-rouge">alloc</code> is a class method, which takes no explicit arguments and return basic <code class="highlighter-rouge">id</code> object. Simple enough, but not too much information here. <a href="https://developer.apple.com/library/content/documentation/General/Conceptual/CocoaEncyclopedia/ObjectAllocation/ObjectAllocation.html#//apple_ref/doc/uid/TP40010810-CH7-SW1">Apple Developer documentation</a> provides more information about what alloc should do.</p>

<p>It says that <code class="highlighter-rouge">alloc</code>:</p>

<ol>
  <li>Calculate the required size and allocate memory for the object</li>
  <li>Set retain count to 1</li>
  <li>Set isa to the class pointer</li>
  <li>Initialize all variables to zero</li>
  <li>Return “raw” (uninitialized) pointer</li>
</ol>

<p>Also there are some references to the aligning, virtual memory, zones.</p>

<p><strong>Under the hood</strong></p>

<p>The provided information is based on the objc4-706.tar.gz source code, available <a href="https://opensource.apple.com/tarballs/objc4">here</a>.</p>

<p><code class="highlighter-rouge">alloc</code> implementation starts from the sequence of calls with passing <code class="highlighter-rouge">Class</code> object (pointer to struct instance of <code class="highlighter-rouge">objc_class</code>). It will be logical to assume that it’s the key factor for object’s size and layout in memory.</p>

<p>There are multiple branches of execution exist in the source code according to the compilation config and used objects. I will provide the flow which I think is used for current Objectice-C 2.0.</p>

<ul>
  <li><code class="highlighter-rouge">+ (id)alloc</code> -&gt;</li>
  <li><code class="highlighter-rouge">id _objc_rootAlloc(Class cls)</code> -&gt;</li>
  <li><code class="highlighter-rouge">id callAlloc(Class cls, bool checkNil, bool allocWithZone=false)</code> -&gt;</li>
  <li><code class="highlighter-rouge">+ (id)allocWithZone:(struct _NSZone *)zone</code> -&gt;</li>
  <li><code class="highlighter-rouge">id _objc_rootAllocWithZone(Class cls, malloc_zone_t *zone)</code> -&gt;</li>
  <li><code class="highlighter-rouge">id class_createInstance(Class cls, size_t extraBytes)</code> -&gt;</li>
  <li><code class="highlighter-rouge">static id _class_createInstance(Class cls, size_t extraBytes)</code> -&gt;</li>
  <li><code class="highlighter-rouge">id _class_createInstanceFromZone(Class cls, size_t extraBytes, void *zone)</code> -&gt;</li>
  <li><code class="highlighter-rouge">id objc_constructInstance(Class cls, void *bytes)</code></li>
</ul>

<p>Basically, last two C functions cover the most part of the job, so I will provide their code to go through.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>id _class_createInstanceFromZone(Class cls, size_t extraBytes, void *zone)
{
    void *bytes;
    size_t size;

    // Can't create something for nothing
    if (!cls) return nil;

    // Allocate and initialize
    size = cls-&gt;alignedInstanceSize() + extraBytes;

    // CF requires all objects be at least 16 bytes.
    if (size &lt; 16) size = 16;

    if (zone) {
        bytes = malloc_zone_calloc((malloc_zone_t *)zone, 1, size);
    } else {
        bytes = calloc(1, size);
    }

    return objc_constructInstance(cls, bytes);
}
</code></pre>
</div>

<p><code class="highlighter-rouge">_class_createInstanceFromZone</code> function contains 3 parts:</p>

<ul>
  <li>Size calculation. Basic part is retrieved in <code class="highlighter-rouge">cls-&gt;alignedInstanceSize()</code>. <code class="highlighter-rouge">alignedInstanceSize</code> doesn’t perform any essential calculations, instance size is already calculated in the Class object. The only additional action over size is to align it to pointer boundary.</li>
  <li>Memory allocation. The default flow is a <code class="highlighter-rouge">calloc</code> call. One important notice that both flows use calloc versions, that means that memory not only allocated, but also is zeroed.</li>
  <li>
    <p>Call of the <code class="highlighter-rouge">objc_constructInstance</code> is the final stage to work over the prepared memory.</p>

    <div class="highlighter-rouge"><pre class="highlight"><code>  id objc_constructInstance(Class cls, void *bytes)
  {
      if (!cls  ||  !bytes) return nil;
        
      id obj = (id)bytes;
        
      obj-&gt;initIsa(cls);

      if (cls-&gt;hasCxxCtor()) {
          return object_cxxConstructFromClass(obj, cls);
      } else {
          return obj;
      }
  }
</code></pre>
    </div>
  </li>
</ul>

<p>Main part of <code class="highlighter-rouge">objc_constructInstance</code> function is <code class="highlighter-rouge">obj-&gt;initIsa(cls)</code> call, where <code class="highlighter-rouge">isa</code> struct’s field is set with <code class="highlighter-rouge">Class</code> value. The call <code class="highlighter-rouge">cls-&gt;hasCxxCtor()</code> at first looks like something unclear. However, if to look over the rest of the objc project for <code class="highlighter-rouge">cxx</code> names it becomes clear, that all such functionality is related to Objective-C++ implementation.</p>

<p><strong>Summary</strong></p>

<p>Documentation for allocation process contains detailed description of the <code class="highlighter-rouge">NSObject's</code> behaviour.
However I didn’t mentioned anywhere above anything about setting retain counter to 1. The reason of such miss is that <code class="highlighter-rouge">retain</code> doesn’t exist in the <code class="highlighter-rouge">alloc</code> functionality at all. <code class="highlighter-rouge">NSObject</code> contains <code class="highlighter-rouge">SideTable</code> struct and related methods responsible for support of reference counting in <code class="highlighter-rouge">NSObject</code>. Actual implementation of the <code class="highlighter-rouge">retainCount</code> function has initial value equal 1. So there is no a lot of sense to mess counter with <code class="highlighter-rouge">alloc</code>. In reality, it doesn’t touch the programmer, because from API point there is no visible difference.</p>

<p><strong>Implementation tricks and details</strong></p>

<p>Analysing source code can bring new ideas and techniques, which I’ll try to share in this section.</p>

<ul>
  <li>
    <p><strong>Branch prediction.</strong> There are a lot of places, where <code class="highlighter-rouge">fastpath()</code> and <code class="highlighter-rouge">slowpath()</code> macros are used. Macro declaration of fastpath: <code class="highlighter-rouge">#define fastpath(x) (__builtin_expect(bool(x), 1));</code> <code class="highlighter-rouge">__builtin_expect</code> could be used in <code class="highlighter-rouge">if-else</code> statements, to tell compiler (optimizer) improve order of instructions by providing expected value of the variable. More information could be found in the official <a href="http://llvm.org/docs/BranchWeightMetadata.html">LLVM docs</a>`.</p>
  </li>
  <li>
    <p><strong>Disable warnings for unused function arguments</strong>. <code class="highlighter-rouge">id _objc_rootAllocWithZone(Class cls, malloc_zone_t *zone)</code> doesn’t use <code class="highlighter-rouge">zone</code> argument in the <strong>OBJC2</strong> build, so to avoid warning additional code line was added.</p>

    <div class="highlighter-rouge"><pre class="highlight"><code>  // allocWithZone under __OBJC2__ ignores the zone parameter
  (void)zone;
</code></pre>
    </div>
  </li>
</ul>

<p><strong>Thank you for reading!</strong></p>

      </div>
    </main>

    <style>
  .noprint {
    border-bottom-style : inset;
    border-bottom-width : 1px;
    border-left-style : inset;
    border-left-width : 1px;
    border-right-style : inset;
    border-right-width : 1px;
    border-top-style : inset;
    border-top-width : 1px;
  }
</style>

<footer>
  <hr class="noprint" >
  <div class="wrapper">
    <div>
      <br>
      <div class="common_footer">
        Based on 
        [<a href="https://github.com/jekyll">Jekyll</a>]
          and [<a href="https://github.com/jekyll/minima">minima</a>] theme. 
        Created on December 24, 2016
      </div>
      <br>
    </div>
  </div>

</footer>

  </body>

</html>
